/**
 * –¢–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ PDF-–æ—Ç—á—ë—Ç–æ–≤
 */

import { generatePdfReportToFile } from '../src/pdf/pdfGenerator.js';
import { createReportHtml } from '../src/pdf/markdownParser.js';
import { extractDataForVisualization } from '../src/pdf/dataExtractor.js';
import { join } from 'path';

// –ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞ –±–æ—Ç–∞ –∏–∑ –≤–∞—à–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
const testBotResponse = `üéØ **–¶–µ–ª—å:** —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–π –≤–∑–Ω–æ—Å –≤ –ü–î–° –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –µ–∂–µ–º–µ—Å—è—á–Ω–æ–π –≤—ã–ø–ª–∞—Ç—ã –≤ —Ä–∞–∑–º–µ—Ä–µ 150 000 ‚ÇΩ –ø–æ—Å–ª–µ –≤—ã—Ö–æ–¥–∞ –Ω–∞ –ø–µ–Ω—Å–∏—é.

üì• **–í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:**
- –í–æ–∑—Ä–∞—Å—Ç: 23 –≥–æ–¥–∞
- –ü–æ–ª: –º—É–∂—Å–∫–æ–π
- –î–æ—Ö–æ–¥: 200 000 ‚ÇΩ –≤ –º–µ—Å—è—Ü
- –°—Ç–∞—Ä—Ç–æ–≤—ã–π –∫–∞–ø–∏—Ç–∞–ª: 100 000 ‚ÇΩ
- –°—Ç–∞–≤–∫–∞ –ù–î–§–õ –¥–ª—è –≤—ã—á–µ—Ç–∞: 15%
- –†–µ–∏–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–ª–æ–≥–æ–≤—ã–π –≤—ã—á–µ—Ç: –¥–∞
- –ü–ª–∞–Ω –Ω–∞—á–∞–ª–∞ –≤—ã–ø–ª–∞—Ç: –ø–æ –æ–±—â–µ–º—É –ø—Ä–∞–≤–∏–ª—É

üìä **–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:**
- –¢—Ä–µ–±—É–µ–º—ã–π –≤–∑–Ω–æ—Å: 143 000 ‚ÇΩ –≤ –º–µ—Å—è—Ü
- –ü—Ä–æ–≥–Ω–æ–∑ –∫–∞–ø–∏—Ç–∞–ª–∞ –∫ –Ω–∞—á–∞–ª—É –≤—ã–ø–ª–∞—Ç: 11 115 000 ‚ÇΩ
- –û—Ü–µ–Ω–∫–∞ –µ–∂–µ–º–µ—Å—è—á–Ω–æ–π –≤—ã–ø–ª–∞—Ç—ã –∏–∑ –∫–∞–ø–∏—Ç–∞–ª–∞ (—á–µ—Ä–µ–∑ 270 –º–µ—Å): 150 000 ‚ÇΩ
- –†–∞–∑–±–∏–≤–∫–∞ –ø—Ä–∏—Ç–æ–∫–∞:
  - üí∞ –õ–∏—á–Ω—ã–µ –≤–∑–Ω–æ—Å—ã: 1 716 000 ‚ÇΩ –≤ –≥–æ–¥
  - üèõÔ∏è –ì–æ—Å–ø–æ–¥–¥–µ—Ä–∂–∫–∞: 858 000 ‚ÇΩ –≤ –≥–æ–¥
  - üí∏ –ù–∞–ª–æ–≥–æ–≤—ã–π –≤—ã—á–µ—Ç: 257 400 ‚ÇΩ –≤ –≥–æ–¥

üéõÔ∏è **–°—Ü–µ–Ω–∞—Ä–∏–∏:**
- –° —Ä–µ–∏–Ω–≤–µ—Å—Ç–æ–º –Ω–∞–ª–æ–≥–æ–≤–æ–≥–æ –≤—ã—á–µ—Ç–∞
- –ë–µ–∑ —Ä–µ–∏–Ω–≤–µ—Å—Ç–∞ –Ω–∞–ª–æ–≥–æ–≤–æ–≥–æ –≤—ã—á–µ—Ç–∞

üí° **–ü–æ–¥—Å–∫–∞–∑–∫–∏:**
- –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ —Å–æ—Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏—è —É—á–∏—Ç—ã–≤–∞–π—Ç–µ –≤–∞—à –¥–æ—Ö–æ–¥.
- –ü–µ—Ä–µ–≤–æ–¥ –û–ü–° –Ω–µ —É—á–∞—Å—Ç–≤—É–µ—Ç –≤ —Å–æ—Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–∏.

‚ö†Ô∏è **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è/—Ä–∏—Å–∫–∏:**
- –†–∞—Å—á—ë—Ç—ã –æ—Å–Ω–æ–≤–∞–Ω—ã –Ω–∞ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏ 10%.
- –ì–æ—Ä–∏–∑–æ–Ω—Ç –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–º –¥–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Ü–µ–ª–∏ –ø—Ä–∏ —Ä–∞–Ω–Ω–µ–º –Ω–∞—á–∞–ª–µ –≤—ã–ø–ª–∞—Ç.`;

async function testPdfGeneration() {
  try {
    console.log('üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é PDF-–æ—Ç—á—ë—Ç–∞...');

    // –¢–µ—Å—Ç–∏—Ä—É–µ–º –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
    console.log('üîç –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏...');
    const visualizationData = extractDataForVisualization(testBotResponse);
    console.log('üìä –ò–∑–≤–ª–µ—á—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:', JSON.stringify(visualizationData, null, 2));

    // –¢–µ—Å—Ç–∏—Ä—É–µ–º HTML-–≥–µ–Ω–µ—Ä–∞—Ü–∏—é
    console.log('üìù –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML —Å —Ç–∞–±–ª–∏—Ü–∞–º–∏ –∏ –≥—Ä–∞—Ñ–∏–∫–∞–º–∏...');
    const html = createReportHtml(testBotResponse, {
      reportDate: new Date().toLocaleDateString('ru-RU', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
      }),
    });

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º HTML –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
    const os = await import('os');
    const tempDir = os.tmpdir();
    const htmlPath = join(tempDir, 'test-report.html');
    const fs = await import('fs/promises');
    await fs.writeFile(htmlPath, html);
    console.log(`‚úÖ HTML —Å–æ—Ö—Ä–∞–Ω—ë–Ω: ${htmlPath}`);

    // –¢–µ—Å—Ç–∏—Ä—É–µ–º PDF-–≥–µ–Ω–µ—Ä–∞—Ü–∏—é
    console.log('üìÑ –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º PDF...');
    const pdfPath = join(tempDir, 'test-report.pdf');
    await generatePdfReportToFile(testBotResponse, pdfPath, {
      reportDate: new Date().toLocaleDateString('ru-RU', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
      }),
      filename: 'test-pension-report',
    });

    console.log(`‚úÖ PDF —Å–æ—Ö—Ä–∞–Ω—ë–Ω: ${pdfPath}`);

    // –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
    try {
      await fs.unlink(htmlPath);
      await fs.unlink(pdfPath);
      console.log('üßπ –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –æ—á–∏—â–µ–Ω—ã');
    } catch (error) {
      // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –æ—á–∏—Å—Ç–∫–∏
    }
    console.log('üéâ –¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à—ë–Ω —É—Å–ø–µ—à–Ω–æ!');
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏:', error.message);
    console.error(error.stack);
    throw error;
  }
}

// –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç
testPdfGeneration();
