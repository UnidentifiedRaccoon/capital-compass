/**
 * –¢–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ PDF-–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –±–æ—Ç–∞
 */

import {
  getChatContext,
  addMessageToContext,
  clearChatContext,
} from '../src/storage/chatContext.js';
import { generatePdfReport } from '../src/pdf/pdfGenerator.js';

// –¢–µ—Å—Ç–æ–≤—ã–π chatId
const TEST_CHAT_ID = 12345;

async function testBotPdfGeneration() {
  try {
    console.log('üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º PDF-–≥–µ–Ω–µ—Ä–∞—Ü–∏—é –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –±–æ—Ç–∞...');

    // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
    clearChatContext(TEST_CHAT_ID);

    // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –¥–∏–∞–ª–æ–≥
    addMessageToContext(TEST_CHAT_ID, 'user', '—Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å');

    const testBotResponse = `üéØ **–¶–µ–ª—å:** —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–π –≤–∑–Ω–æ—Å –≤ –ü–î–° –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –µ–∂–µ–º–µ—Å—è—á–Ω–æ–π –≤—ã–ø–ª–∞—Ç—ã –≤ —Ä–∞–∑–º–µ—Ä–µ 150 000 ‚ÇΩ –ø–æ—Å–ª–µ –≤—ã—Ö–æ–¥–∞ –Ω–∞ –ø–µ–Ω—Å–∏—é.

üì• **–í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:**
- –í–æ–∑—Ä–∞—Å—Ç: 23 –≥–æ–¥–∞
- –ü–æ–ª: –º—É–∂—Å–∫–æ–π
- –î–æ—Ö–æ–¥: 200 000 ‚ÇΩ –≤ –º–µ—Å—è—Ü
- –°—Ç–∞—Ä—Ç–æ–≤—ã–π –∫–∞–ø–∏—Ç–∞–ª: 100 000 ‚ÇΩ
- –°—Ç–∞–≤–∫–∞ –ù–î–§–õ –¥–ª—è –≤—ã—á–µ—Ç–∞: 15%
- –†–µ–∏–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–ª–æ–≥–æ–≤—ã–π –≤—ã—á–µ—Ç: –¥–∞
- –ü–ª–∞–Ω –Ω–∞—á–∞–ª–∞ –≤—ã–ø–ª–∞—Ç: –ø–æ –æ–±—â–µ–º—É –ø—Ä–∞–≤–∏–ª—É

üìä **–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:**
- –¢—Ä–µ–±—É–µ–º—ã–π –≤–∑–Ω–æ—Å: 143 000 ‚ÇΩ –≤ –º–µ—Å—è—Ü
- –ü—Ä–æ–≥–Ω–æ–∑ –∫–∞–ø–∏—Ç–∞–ª–∞ –∫ –Ω–∞—á–∞–ª—É –≤—ã–ø–ª–∞—Ç: 11 115 000 ‚ÇΩ
- –û—Ü–µ–Ω–∫–∞ –µ–∂–µ–º–µ—Å—è—á–Ω–æ–π –≤—ã–ø–ª–∞—Ç—ã –∏–∑ –∫–∞–ø–∏—Ç–∞–ª–∞ (—á–µ—Ä–µ–∑ 270 –º–µ—Å): 150 000 ‚ÇΩ
- –†–∞–∑–±–∏–≤–∫–∞ –ø—Ä–∏—Ç–æ–∫–∞:
  - üí∞ –õ–∏—á–Ω—ã–µ –≤–∑–Ω–æ—Å—ã: 1 716 000 ‚ÇΩ –≤ –≥–æ–¥
  - üèõÔ∏è –ì–æ—Å–ø–æ–¥–¥–µ—Ä–∂–∫–∞: 858 000 ‚ÇΩ –≤ –≥–æ–¥
  - üí∏ –ù–∞–ª–æ–≥–æ–≤—ã–π –≤—ã—á–µ—Ç: 257 400 ‚ÇΩ –≤ –≥–æ–¥

üéõÔ∏è **–°—Ü–µ–Ω–∞—Ä–∏–∏:**
- –° —Ä–µ–∏–Ω–≤–µ—Å—Ç–æ–º –Ω–∞–ª–æ–≥–æ–≤–æ–≥–æ –≤—ã—á–µ—Ç–∞
- –ë–µ–∑ —Ä–µ–∏–Ω–≤–µ—Å—Ç–∞ –Ω–∞–ª–æ–≥–æ–≤–æ–≥–æ –≤—ã—á–µ—Ç–∞

üí° **–ü–æ–¥—Å–∫–∞–∑–∫–∏:**
- –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ —Å–æ—Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏—è —É—á–∏—Ç—ã–≤–∞–π—Ç–µ –≤–∞—à –¥–æ—Ö–æ–¥.
- –ü–µ—Ä–µ–≤–æ–¥ –û–ü–° –Ω–µ —É—á–∞—Å—Ç–≤—É–µ—Ç –≤ —Å–æ—Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–∏.

‚ö†Ô∏è **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è/—Ä–∏—Å–∫–∏:**
- –†–∞—Å—á—ë—Ç—ã –æ—Å–Ω–æ–≤–∞–Ω—ã –Ω–∞ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏ 10%.
- –ì–æ—Ä–∏–∑–æ–Ω—Ç –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–º –¥–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Ü–µ–ª–∏ –ø—Ä–∏ —Ä–∞–Ω–Ω–µ–º –Ω–∞—á–∞–ª–µ –≤—ã–ø–ª–∞—Ç.`;

    addMessageToContext(TEST_CHAT_ID, 'assistant', testBotResponse);

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
    const context = getChatContext(TEST_CHAT_ID);
    console.log('üìã –ö–æ–Ω—Ç–µ–∫—Å—Ç —á–∞—Ç–∞:', {
      totalMessages: context.length,
      userMessages: context.filter((msg) => msg.role === 'user').length,
      assistantMessages: context.filter((msg) => msg.role === 'assistant').length,
    });

    // –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –æ—Ç–≤–µ—Ç –±–æ—Ç–∞ (–∫–∞–∫ –≤ –±–æ—Ç–µ)
    const lastBotMessage = context.filter((msg) => msg.role === 'assistant').pop();

    if (!lastBotMessage) {
      console.error('‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á—ë—Ç–∞');
      return;
    }

    console.log('üìù –ü–æ—Å–ª–µ–¥–Ω–∏–π –æ—Ç–≤–µ—Ç –±–æ—Ç–∞:', {
      hasMessage: !!lastBotMessage,
      messageLength: lastBotMessage.text.length,
      preview: lastBotMessage.text.substring(0, 100) + '...',
    });

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º PDF
    console.log('üìÑ –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º PDF...');
    const pdfBuffer = await generatePdfReport(lastBotMessage.text, {
      reportDate: new Date().toLocaleDateString('ru-RU', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
      }),
      filename: `test-bot-pdf-${TEST_CHAT_ID}`,
    });

    console.log(`‚úÖ PDF —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω —É—Å–ø–µ—à–Ω–æ! –†–∞–∑–º–µ—Ä: ${pdfBuffer.length} –±–∞–π—Ç`);
    console.log('üéâ –¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à—ë–Ω —É—Å–ø–µ—à–Ω–æ!');
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏:', error.message);
    console.error('Stack trace:', error.stack);
    throw error;
  }
}

// –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç
testBotPdfGeneration();
